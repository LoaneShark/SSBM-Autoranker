<!DOCTYPE html>
<html lang="{{ site.lang | default: "en-US" }}">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ "/assets/css/style.css?v=" | append: site.github.build_revision | relative_url }}">
    {% include bootstrap_css.html %}
    {% include bootstrap_scripts.html %}

<style type="text/css">
/*#player_searchbar .tt-dropdown-menu {
  max-height: 150px;
  overflow-y: auto;
}*/
.jumbotron{
  position: relative;
  padding:5px;
  /*display: flex;
  width: 700px;
  margin: 0 auto;
  align-items: center;*/
}
.jumbotron .container {
  position: relative;
  padding:30px;
  /*display: flex;*/
}
.card-img-top {
  height:5vw;
  object-fit:cover;
}
.card-title {

}
.display-4 {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.p-2 .propic {

}

/*
.custom-switch:before {
  content: "Scores";
}
.custom-switch:after {
  content: "Ranks";
}*/
</style>
<link rel="icon" href="/assets/images/site_icons/sr_logo_minimal.png">
<link rel="apple-touch-icon" sizes="128x128" href="/assets/images/site_icons/sr_logo_touch_icon.png">
<link href="/assets/css/flags.css" rel=stylesheet type="text/css">
<link href="/assets/css/typeahead_bootstrap.css" rel="stylesheet" type="text/css">
{% seo %}
    <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container" style="width:65vw">
      <header>
        {% include navigation.html %}
        {% if page.url == "/" %}
          <h1><a href="{{ "/" | absolute_url }}">{{ site.title | default: site.github.repository_name }}</a></h1>
          {% endif %}
        
        {% if site.logo %}
          <img src="{{site.logo | relative_url}}" alt="Logo" />
        {% endif %}
      </header>
      <section>

      {{ content }}

      </section>

      {% include player_search.html %}
      <div class="invisible" id="warning_div">
        <p class="h5" id="warning_div_text"></p>
      </div>
      <div class="jumbotron shadow rounded invisible" id="player_card">
      </div>
      {% include footer.html %}
    </div>

    <!-- Player Profile scripts -->

    {% include firebase_scripts.html %}
    <script type="text/javascript" src="/assets/js/finch.min.js"></script>
    <script type="text/javascript" src="/assets/js/typeahead.bundle.js"></script>
    <script type="text/javascript" src="/assets/js/misc_utils.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.bundle.min.js" async></script>
    <script type="text/javascript" src="/assets/js/graph_utils.js" async></script>
    <!-- Searchbar -->
    <script>
      $('.typeahead').bind('typeahead:select', function(ev, suggestion) {
        Finch.navigate(''+suggestion.id);
      });

      var gameId = getGameId('{{page.game}}')
      //var searchbar_ref = firebase.database().ref("/"+gameId+"_2018_1/p_info");
      var searchbar_ref = firebase.database().ref("/"+gameId+"_2016_3_c/p_info");
      var searchbar_query = searchbar_ref.orderByChild('srank').limitToFirst(500);
      var searchbar_contents = searchbar_query.once('value').then(function(PlayerInfoSnapshot) {
        if (PlayerInfoSnapshot.exists()) {
          var searchbar_players = snapshotToSearchbar(PlayerInfoSnapshot,attr="key");
          // custom tokenizer, so that search is sensetive to gamertag, player id, or any known aliases
          function customTokenizer(datum) {
            var nameTokens = Bloodhound.tokenizers.whitespace(datum.name);
            var idTokens = Bloodhound.tokenizers.whitespace(datum.id);
            var returnTokens = nameTokens.concat(idTokens);
            for (i=0;i<datum.aliases.length;i++){
              returnTokens = returnTokens.concat(Bloodhound.tokenizers.whitespace(datum.aliases[i]))
            }
            return returnTokens
          }
          var searchbar_engine = new Bloodhound({
            datumTokenizer: customTokenizer,
            //datumTokenizer: Bloodhound.tokenizers.whitespace,
            queryTokenizer: Bloodhound.tokenizers.whitespace,
            identify: function(obj) {return obj.id},
            local: searchbar_players
          });
          searchbarTypeahead = $('#player_searchbar .typeahead').typeahead({
            hint: true,
            highlight: true,
            minLength: 1
          },{
            name: 'players',
            //display: function(obj) {return obj.name;},
            displayKey: 'name',
            //limit: 10,
            source: searchbar_engine,
            templates: {
              //suggestion: Handlebars.compile('<div><strong>{{name}}</strong> - {{id}}</div>'),
              empty: ['<div><p class="text-muted">Search...</p></div>']
            }
          });

          searchbarTypeahead.on('typeahead:initialized', function (event, data) {
             // After initializing, hide the progress icon.
             $('.tt-hint').css('background-image', '');
          });
          // Show progress icon while loading.
          $('.tt-hint').css('background-image', 'url("/assets/images/social_icons/pizza-600px.png")');
            }
          });
    </script>

    <!-- Player Profile -->
    <script>
      var currentDB = true;

      Finch.route("/", function(bindings){
        console.log("No player selected");
        $('#player_card').addClass("invisible");
      });
      Finch.route("/:p_id", function(bindings){
        console.log("Loading player page: "+bindings.p_id);
        $('#player_card').removeClass("invisible");
        // draw player profile segment
        $('#player_card').html(`{% include player_profile.html %}`);

        var playerId = bindings.p_id;
        var gameId = getGameId('{{page.game}}');
        var curr_year = new Date().getFullYear();
        $('#game_icon_div').html('<img src="'+getGameIconPath(gameId)+'" alt="'+gameId+'" style="width:20px;height:20px;">');

        // query db and populate profile
        if (currentDB){
          var player_ref_str = "/"+gameId+"_2016_"+(curr_year-2016)+"_c/p_info/"+playerId;
        } else {
          var player_ref_str = "/"+gameId+"_2018_1/p_info/"+playerId;
        }
        var player_ref = firebase.database().ref(player_ref_str);
        var player_query = player_ref.once('value').then(function(PlayerSnapshot) {
          if (PlayerSnapshot.exists()) {
            $('#warning_div').addClass('invisible');
            //var player_tuple = 
            var p_tag = PlayerSnapshot.child('tag').val();
            $('#player_tag').html(p_tag);
            $('#player_team').html(PlayerSnapshot.child('team').val());
            var p_region = PlayerSnapshot.child('region').val();
            console.log(p_region)
            if (p_region[2] != 'N/A'){
              $('#player_region_div').removeClass('invisible');
              $('#player_region').html(p_region[2]);
              // draw country flag in region box
              if (p_region[1] == 'Europe' || p_region[1] == 'America'){
                var c_code = countryNameToCC(p_region[2])
              } else if (p_region[1] == 'USA'){
                var c_code = countryNameToCC('United States')
              } else {
                var c_code = countryNameToCC(p_region[1]);
              }
              if (c_code){
                $('#player_region_flag').addClass('flag-'+c_code.toLowerCase());
              } else {
                $('#player_region_flag').addClass('invisible');
              }
              if (p_region[2] == 'MD/VA'){
                $('#player_region_map').attr('src','/assets/images/region_maps/map_mdva.png')
              }
            }
            var propic_url = PlayerSnapshot.child('propic').val();
            if (propic_url == null){
              propic_url = "https://via.placeholder.com/100/81daea/f2f2f2?text="+p_tag.slice(0,1)
            }
            $('#player_propic_div').html('<img src="'+propic_url+'" alt="'+p_tag+'" class="rounded-circle"/>');
            $('#player_name').html(PlayerSnapshot.child('firstname').val()+' '+PlayerSnapshot.child('lastname').val());
            var player_active = PlayerSnapshot.child('active');
            if (player_active.exists()) {
              if (player_active.val()){
                $('#player_status').html('Active');
                $('#player_status').addClass('text-success');
              } else {
                $('#player_status').html('Inactive');
                $('#player_status').addClass('text-danger');
              }
            }
            var p_aliases = PlayerSnapshot.child('aliases').val();
            if (p_aliases.length > 1){
              p_aliases = p_aliases.filter(function(value, index, arr){
                return value != p_tag;
              });
              $('#player_aliases').html(p_aliases.join());
              $('#player_aliases_div').removeClass('invisible');
            }
            // add social media accounts
            acctNames = ['twitter','twitch','smashboards','ssbwiki','youtube','discord','reddit'];
            acctIcons = ['twt-512px.png','ttv-322px.jpg','sb-280px.jpg','sw-200px.png','ytb-800px.png','dcd-800px.png','rdt-256px.png']
            acctStubs = ['twitter.com/','twitch.tv/','smashboards.com/members/','ssbwiki.com/Smasher:','youtube.com/channel/','','reddit.com/u/']
            for (i=0;i<acctNames.length;i++){
              if (PlayerSnapshot.child(acctNames[i]).exists()){
                $('#player_social').append('<a href="https://'+acctStubs[i]+PlayerSnapshot.child(acctNames[i]).val()+'" target="_blank"><img src="/assets/images/social_icons/'+acctIcons[i]+'" alt="'+PlayerSnapshot.child(acctNames[i]).val()+'" style="width:32px;height:32px;padding:1px;" class="rounded"></a>');
                // show social media links section
                $('#player_social_div').removeClass('invisible')
              }
            }
            // easter egg :3
            if (playerId == 16342){
              var showPizza = true;
              $('#player_social').append('<a href="//axe.pizza" target="_blank"><img src="/assets/images/social_icons/pizza-600px.png" alt="axe.pizza" style="width:32px;height:32px;padding:1px;" class="rounded img-fluid"></a>')
            }
            var player_otherGamesPromise = otherGameActivity(playerId,gameId);
            //console.log(player_otherGamesPromise);
            player_otherGamesPromise.then(function(player_otherGames){
              //console.log(player_otherGames)
              if (player_otherGames.length > 1) {
                for (i=0;i<player_otherGames.length;i++){
                  if (player_otherGames[i] != gameId){
                    $('#player_games').append('<a href="/games/'+getGameTitle(player_otherGames[i]).toLowerCase()+'/players/#'+playerId+'"><img src="'+getGameIconPath(player_otherGames[i])+'"  alt="'+player_otherGames[i]+'" style="width:30px;height:30px;"></a>');
                  }
                }
                $('#player_games_div').removeClass('invisible');
              }
            });
            // onerror="this.onerror=null;this.src=\''++'\';" />');
            //$('#player_characters').html(PlayerSnapshot.child('main'+'/'+PlayerSnapshot.child('last_event').val()).val());
            
            // calculate character usage
            if (PlayerSnapshot.child('characters').exists()) {
              var p_characters = PlayerSnapshot.child('characters').val();
              var p_character_keys = Object.keys(p_characters);
              var p_used_characters = [];
              for (i=0; i<p_character_keys.length; i++){
                var k = p_character_keys[i];
                if (p_characters[k][0] + p_characters[k][1] > 0){
                  p_used_characters.push([k,p_characters[k][0] + p_characters[k][1]]);
                }
              }
              // sort by usage
              p_used_characters.sort(function(a,b){
                return b[1]-a[1];
              });
              // get total N
              var totalSets = p_used_characters.reduce(function(total,num){
                return total + num[1];
              },0);
              // draw icons
              if (p_used_characters.length > 0){
                for (i=0;i<p_used_characters.length;i++){
                  // assign usage percents as tooltips
                  usagePct = Math.round(p_used_characters[i][1]*10000.0/totalSets)/100.0;
                  $('#player_characters').append(
                    '<span id="char_'+p_used_characters[i][0]+'_span" data-toggle="tooltip" title="'+usagePct+'%">' +
                      '<img id="char_'+p_used_characters[i][0]+'_img" src="'+getStockIconPath(gameId,p_used_characters[i][0])+'" alt="'+p_used_characters[i][0]+'" style="width:26px;height:26px;padding:1px;">' +
                    '</span>');
                  if (i > 0){
                    var newLine = '\n';
                  } else {
                    var newLine = '';
                  }
                  //$('#player_characters_div').attr('title',$('#player_characters_div').attr('title')+newLine+usagePct+'%')
                }
                $('#player_characters_div').removeClass('invisible');
                $('[data-toggle="tooltip"]').tooltip();
              }
            }

            // populate skills
            var eloVal = Math.round(PlayerSnapshot.child('elo').val());
            var glickoVal = Math.round(PlayerSnapshot.child('glicko').val()[0]);
            var srankVal = Math.round(PlayerSnapshot.child('srank').val()*1000.)/1000.;

            var eloRnkVal = PlayerSnapshot.child('elo-rnk').val();
            eloRnkVal = ''+eloRnkVal+'<sup>'+ordinalSuffixOf(eloRnkVal)+'</sup>';
            var glickoRnkVal = PlayerSnapshot.child('glicko-rnk').val();
            glickoRnkVal = ''+glickoRnkVal+'<sup>'+ordinalSuffixOf(glickoRnkVal)+'</sup>';
            var srankRnkVal = PlayerSnapshot.child('srank-rnk').val();
            srankRnkVal = ''+srankRnkVal+'<sup>'+ordinalSuffixOf(srankRnkVal)+'</sup>';

            if (PlayerSnapshot.child('mainrank').exists()){
              var mainrankVal = PlayerSnapshot.child('mainrank').val();
            } else {
              var mainrankVal = 'N/A'
            }
            $('#player_elo').html(eloVal);
            $('#player_glicko').html(glickoVal);
            $('#player_srank').html(srankVal);
            $('#player_mainrank').html(mainrankVal);
            //$('#player_trueskill').html(Math.round(PlayerSnapshot.child('trueskill').val()));

            // populate h2h-at-a-glance
            var playerRecordStr = '/' + gameId + '_2016_' + (curr_year-2016)+ '_c' + '/records/'+playerId;
            var playerRecordRef = firebase.database().ref(playerRecordStr);
            var playerRecordQuery = playerRecordRef.once('value').then(function(RecordSnapshot){
              if (RecordSnapshot.exists()){

                var playerWins = RecordSnapshot.child('wins').val();
                var playerLosses = RecordSnapshot.child('losses').val();
                var h2h = {'top10w':0,'top10l':0,'top100w':0,'top100l':0,'top500w':0,'top500l':0};

                if (playerWins != null || playerLosses != null){
                  var topPlayerRefStr = '/' + gameId + '_2016_' + (curr_year-2016)+ '_c' + '/p_info';
                  var topPlayerRef = firebase.database().ref(topPlayerRefStr);
                  var topPlayerQuery = topPlayerRef.orderByChild('srank').limitToFirst(500).once('value').then(function(TopPlayerSnapshot){
                    if (TopPlayerSnapshot.exists()){
                      TopPlayerSnapshot.forEach(function(childSnapshot){
                        oppId = childSnapshot.key;
                        oppSkillRank = childSnapshot.child('srank-rnk').val();
                        if (playerWins != null){
                          if (oppId in playerWins){
                            h2h['top500w'] += 1;
                            if (oppSkillRank <= 100){
                              h2h['top100w'] += 1;
                              if (oppSkillRank <= 10){
                                h2h['top10w'] += 1;
                              }
                            }
                          }
                        }
                        if (playerLosses != null){
                          if (oppId in playerLosses){
                            h2h['top500l'] += 1;
                            if (oppSkillRank <= 100){
                              h2h['top100l'] += 1;
                              if (oppSkillRank <= 10){
                                h2h['top10l'] += 1;
                              }
                            }
                          }
                        }
                      });
                      $('#top500_h2h').html('<span class="text-success">'+h2h['top500w']+'</span>-<span class="text-danger">'+h2h['top500l']+'</span>');
                      $('#top100_h2h').html('<span class="text-success">'+h2h['top100w']+'</span>-<span class="text-danger">'+h2h['top100l']+'</span>');
                      $('#top10_h2h').html('<span class="text-success">'+h2h['top10w']+'</span>-<span class="text-danger">'+h2h['top10l']+'</span>');
                    }
                  });
                } else {
                  $('#top10_h2h').html('0-0')
                  $('#top100_h2h').html('0-0')
                  $('#top500_h2h').html('0-0')
                  //$('#top10_h2h_div').addClass('invisible');
                  //$('#top100_h2h_div').addClass('invisible');
                }
              }
              // draw srank sigmoid skill chart
              var sigmoidParams = PlayerSnapshot.child('srank_sig').val();
              var infoRefStr = '/'+gameId+'_2016_'+(curr_year-2016)+'_c/p_info/';
              winps = winprobsFromRecords(playerWins,playerLosses);

              var sigChart = sigmoidChart(PlayerSnapshot,infoRefStr,sigmoidParams,winps,srankVal);
              if (sigChart != null){
                sigChart.update();
              } else {
                $('srank_sigmoid_container').addClass('invisible')
                $('srank_switch').addClass('disabled')
              }

            });

            // add today's date/watermark
            var utc_date = new Date().toJSON().slice(0,10).replace(/-/g,'/');
            $('#today_date').html(utc_date);

            // get last events
            if (currentDB){
              var placeRef = firebase.database().ref("/"+gameId+"_2016_"+(curr_year-2016)+"_c/records/"+playerId+"/placings");
            } else {
              var placeRef = firebase.database().ref("/"+gameId+"_2018_1/records/"+playerId+"/placings");
            }
            var placeQuery = placeRef.once('value').then(function(PlacementSnapshot){
              var placements = snapshotToArray(PlacementSnapshot,attr="both");
              var eventPromises = placementsToEvents(placements,gameId);
              // populate the cards
              Promise.all(eventPromises).then(function(PlayerEvents){
                if (PlayerEvents.length>0){
                  // sort chronologically
                  PlayerEvents.sort(function(a,b){
                    return b[1]-a[1];
                  });
                  for (i=0;i<placements.length;i++){
                    placements[i].idx = PlayerEvents.findIndex(function(p_event){
                      return p_event[6] == placements[i].key
                    });
                  }
                  placements.sort(function(a,b){
                    return a.idx-b.idx;
                  });
                  for (i=0;i<4;i++){
                    var eventRes = placements[i];
                    if (eventRes != null){
                      $('#event_card_'+i).removeClass('invisible')
                      var eventId = eventRes.key;
                      // eventInfo = [eventName,eventDate,numEntrants,isActive,bannerUrl,slug,eventId]
                      var eventInfo = PlayerEvents[i];
                      var smashggUrl = 'http://www.smash.gg/tournament/'+eventInfo[5];
                      
                      $('#event_card_title_'+i).html(eventInfo[0]);
                      $('#event_card_image_'+i).attr('src',eventInfo[4]);
                      $('#event_card_image_'+i).attr('alt',eventId);
                      $('#event_card_image_link_'+i).attr('href',smashggUrl);
                      eventDate = new Date(eventInfo[1]).toJSON().slice(0,10).replace(/-/g,'/');
                      eventDate = eventDate.slice(5,10)+'/'+eventDate.slice(0,4);
                      $('#event_card_footer_text_'+i).html(eventDate);
                      if (!eventInfo[3]){
                        $('#event_card_footer_text_'+i).addClass('text-danger');
                      }
                      $('#event_card_text_'+i).html('<strong>'+eventRes.val+'</strong>'+' / '+ eventInfo[2]);
                    }
                  }
                }
              });
              // draw skill graphs
              if (currentDB){
                var tourneyRefStr = '/'+gameId+'_2016_'+(curr_year-2016)+'_c/tourneys/'
              } else {
                var tourneyRefStr = '/'+gameId+'_2018_1/tourneys/'
              }
              var tourneyRef = firebase.database().ref(tourneyRefStr);
              var tourneyQuery = tourneyRef.once('value').then(function(TourneySnapshot){
                if (TourneySnapshot.exists()){
                  // fix this
                  //skillTypes = ['elo'];
                  skillTypes = ['mainrank','elo','glicko','srank'];
                  if (currentDB){
                    var skillRefStr = '/'+gameId+'_2016_'+(curr_year-2016)+'_c/skills/';
                  } else {
                    var skillRefStr = '/'+gameId+'_2018_1/skills/';
                  }
                  var skillPromises = snapshotToSkillHistory(skillRefStr,playerId,skillTypes)
                  Promise.all(skillPromises).then(function(PlayerSkills){
                    for (i=0;i<skillPromises.length;i++){
                      skillHistory = PlayerSkills[i];
                      if (skillHistory != null){
                        var timeChart = skillChart(skillHistory,TourneySnapshot,PlacementSnapshot,gameId,skillTypes[i]);
                        if (timeChart != null){
                          timeChart.update();
                        } else {
                          // disable buttons/charts if they are inactive
                          $('#player_'+skillTypes[i]+'_button').addClass('disabled');
                          $('#'+skillTypes[i]+'_chart_container').addClass('invisible');
                        }
                      } else {
                        $('#player_'+skillTypes[i]+'_button').addClass('disabled');
                        $('#player_'+skillTypes[i]).html('N/A');
                        $('#'+skillTypes[i]+'_chart_container').addClass('invisible');
                        console.log(skillTypes[i]+' skillHistory does not exist!');
                      }
                    }// endfor
                  });
                } else {
                  console.log('TourneySnapshot does not exist!');
                }
              });

              $('input:checkbox').change(function() {
                //$('#checkbox_status').html('Toggle: ' + $(this).prop('checked'));
                if (this.id == 'skill_switch'){
                  if ($(this).prop('checked')){
                    $('#player_elo').html(eloRnkVal);
                    $('#player_glicko').html(glickoRnkVal);
                    $('#player_srank').html(srankRnkVal);
                  } else {
                    //var eloVal = Math.round(PlayerSnapshot.child('elo').val());
                    //var glickoVal = Math.round(PlayerSnapshot.child('glicko').val()[0]);
                    //var srankVal = Math.round(PlayerSnapshot.child('srank').val()*1000.)/1000.;
                    $('#player_elo').html(eloVal);
                    $('#player_glicko').html(glickoVal);
                    $('#player_srank').html(srankVal);
                  }
                  //$('#player_elo').html(eloVal);
                  //$('#player_glicko').html(glickoVal);
                  //$('#player_srank').html(srankVal);
                } else if (this.id == 'srank_switch'){
                  if ($(this).prop('checked')){
                    $('#srank_skill_container').removeClass('show');
                    $('#srank_sigmoid_container').addClass('show');
                  } else {
                    $('#srank_skill_container').addClass('show');
                    $('#srank_sigmoid_container').removeClass('show');
                  }
                }
              });
            });
            // make jumbotron visible (now that it's loaded)
            $('player_card').removeClass('invisible');
          } else {
            $('#warning_div_text').html('Player ID not in [{{page.game}}] database: '+bindings.p_id);
            $('#warning_div').removeClass('invisible');
            $('#player_card').addClass('invisible');
          }
        });
        //$('#player_id').html(bindings.p_id);
      });
      /*Finch.route("{{page.url}}:home", function(bindings){
        console.log("Run on home");
      });
      Finch.route("{{page.url}}:x", function(bindings){
        console.log("Hey! You're trying to go here: {#bindings.x}");
      });*/
      Finch.listen();
    </script>

    <!-- Initialize Tooltips -->
    <script>
      $(document).ready(function(){
        $('[data-toggle="tooltip"]').tooltip({
          animated: 'fade'
        });
      });
    </script>

    <!-- Mobile scaling fix -->
    <script src="{{ "/assets/js/scale.fix.js" | relative_url }}"></script>

    <!-- Google Analytics shtuff -->
    {% if site.google_analytics %}
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', '{{ site.google_analytics }}', 'auto');
      ga('send', 'pageview');
    </script>
    {% endif %}
  </body>
</html>